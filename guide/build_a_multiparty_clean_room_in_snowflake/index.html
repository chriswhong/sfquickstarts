
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Build a Multiparty Data Clean Room in Snowflake</title>

  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5Q8R2G');</script>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08H27EW14N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-08H27EW14N');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q8R2G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <google-codelab-analytics gaid="UA-41491190-9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="build_a_multiparty_clean_room_in_snowflake"
                  title="Build a Multiparty Data Clean Room in Snowflake"
                  environment="web"
                  feedback-link="https://github.com/Snowflake-Labs/sfguides/issues">
    
      <google-codelab-step label="Overview" duration="5">
        <p>Data Clean Rooms (DCRs) are secure environments that enable multiple organizations (or divisions of an organization) to bring data together for joint analysis under defined guidelines and restrictions that keep the data secure.  These guidelines control what data comes into the clean room, how the data within the clean room can be joined with other data in the clean room, the kinds of analytics that can be performed on the clean room data, and what data - if any - can leave the clean room environment.</p>
<p>A common use case for DCRs is publishers sharing advertising impression data with advertisers. Of course, big advertisers work with multiple publishers, and it is common for advertisers to understand the incremental reach of their media.  For a longer discussion of this, see the <a href="https://quickstarts.snowflake.com/guide/reach_and_frequency_queries/index.html#0" target="_blank">Reach and Frequency Quickstart</a>.  In order to answer this question in a DCR environment, a multiparty clean room is needed.  In this Quickstart, we walk through answering this question using a three-party data clean room with two providers (publishers) and one consumer (the advertiser).</p>
<aside class="warning"><p><strong>Caveat:</strong> This Data Clean Room QuickStart is for illustrative purposes only, as a hands-on lab intended to show some of the basic features used to build a data clean room on Snowflake. The result of this lab must not be used in a production environment.</p>
</aside>
<h2 is-upgraded>Prerequisites</h2>
<ul>
<li>Familiarity with Snowflake&#39;s <a href="https://www.snowflake.com/blog/distributed-data-clean-rooms-powered-by-snowflake/" target="_blank">unique DCR architecture</a></li>
<li>Working knowledge with Snowflake database objects and the <a href="https://docs.snowflake.com/en/user-guide/ui-web.html" target="_blank">Snowflake Web UI</a></li>
<li>Clear understanding of how Snowflake <a href="https://docs.snowflake.com/en/user-guide/data-sharing-intro.html" target="_blank">Secure Data Sharing</a> works</li>
<li>Experience going through the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#0" target="_blank">two-party Data Clean Room Quickstart</a></li>
</ul>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>How to create and deploy a DCR environment between three Snowflake accounts</li>
<li>How the two-party clean room can be extended to a third account (a second provider)</li>
</ul>
<h2 is-upgraded>What you&#39;ll build</h2>
<p>This Quickstart lab will walk you through the process of deploying a Snowflake <strong>v5.5</strong> DCR environment, which is our latest General Availability (GA) release.</p>
<ul>
<li>Shows a multi-party DCR environment</li>
<li>Leverages Jinja SQL templating language tags and logic</li>
<li>Includes example query templates for some common advertising scenarios</li>
</ul>
<h2 is-upgraded>What you&#39;ll need</h2>
<ul>
<li><strong>Three</strong> Snowflake accounts - either <a href="https://docs.snowflake.com/en/user-guide/intro-editions.html" target="_blank">Enterprise or Business Critical edition</a> - that are deployed in the <strong>same </strong><a href="https://docs.snowflake.com/en/user-guide/intro-regions.html" target="_blank">cloud provider and region</a>. You may procure these as <a href="https://docs.snowflake.com/en/user-guide/admin-trial-account.html" target="_blank">Snowflake 30-day free trial accounts</a> to make things easier for you - Simply go through the signup process three times on <a href="https://signup.snowflake.com" target="_blank">signup.snowflake.com</a>, making certain to select the <strong>same cloud provider and region</strong> for each. You may reuse the two accounts created for the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#0" target="_blank">two-party Data Clean Room Quickstart</a>, if they are still available, and simply add a third.</li>
<li>Logins to <strong>all</strong> of the Snowflake accounts should have <a href="https://docs.snowflake.com/en/user-guide/security-access-control-considerations.html" target="_blank">ACCOUNTADMIN role access</a> (note that <a href="https://docs.snowflake.com/en/user-guide/admin-trial-account.html" target="_blank">Snowflake free trial accounts</a> provide this automatically, which is why I suggest using them for this Quickstart).</li>
</ul>
<h2 is-upgraded>Attribution</h2>
<p>This Quickstart draws heavily on the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#0" target="_blank">one written by Craig Warman</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Getting started" duration="10">
        <h2 is-upgraded>Log into all Snowflake accounts</h2>
<p>First, you must log in to each of the accounts created earlier.  As mentioned, the logins that you use for these Snowflake accounts must have <a href="https://docs.snowflake.com/en/user-guide/security-access-control-considerations.html" target="_blank">ACCOUNTADMIN role access</a> and all accounts must be deployed in the <strong>same </strong><a href="https://docs.snowflake.com/en/user-guide/intro-regions.html" target="_blank">cloud and region</a>. You should now log in to each account simultaneously using separate browser tabs or windows.</p>
<h2 is-upgraded>Designate two provider accounts and one consumer account</h2>
<p>Two of the three accounts will be providers (publishers), and the third account will be the consumer.  Designate one as the first provider, PROVIDER_1, another as the second, PROVIDER_2, and the third as the consumer, CONSUMER_1.</p>
<h2 is-upgraded>Acknowledge Snowflake Third Party Terms</h2>
<p>This DCR deployment utilizes open-source Python packages that are built and provided by Anaconda.  Consequently it&#39;ll be necessary to acknowledge the <a href="https://www.snowflake.com/legal/third-party-terms/" target="_blank">Snowflake Third Party Terms</a> before proceeding.  You can do this by following <a href="https://docs.snowflake.com/en/developer-guide/udf/python/udf-python-packages.html#using-third-party-packages-from-anaconda" target="_blank">these instructions</a> in <em>all three</em> accounts: the PROVIDER_1, PROVIDER_2 and CONSUMER_1 accounts.  Again, you <em>must</em> successfully complete this step in order to proceed with the DCR installation process.</p>
<h2 is-upgraded>Note PROVIDER_1, PROVIDER_2, and CONSUMER_1 account identifiers</h2>
<p>Each Snowflake account is assigned <a href="https://docs.snowflake.com/en/user-guide/admin-account-identifier.html" target="_blank">a unique identifier</a> (sometimes called a Locator) within its cloud provider and region.  If you took my recommendation to use <a href="https://docs.snowflake.com/en/user-guide/admin-trial-account.html" target="_blank">Snowflake 30-day free trial accounts</a> then these will be a random combination of letters and numbers, such as &#34;GQB12697&#34;.  Please go ahead and determine your account identifiers by opening a new worksheet and running the following command in each account&#39;s UI:</p>
<pre><code language="language-sql" class="language-sql">select current_account();
</code></pre>
<p>It should look like the following:</p>
<p class="image-container"><img alt="Account Identifier Screenshot" src="img/5f3e6ad65c31047e.png"></p>
<p>Be sure to note which account identifier corresponds to the PROVIDER_1, PROVIDER_2 and CONSUMER_1 accounts as you will need these later.</p>
<h2 is-upgraded>Generate PROVIDER_1 and CONSUMER_1 setup scripts</h2>
<p>First, we generate the scripts for the first provider and the consumer as in the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#0" target="_blank">two-party Quickstart</a>. If re-using the accounts used previously for the two-party Quickstart, you do not have to repeat this section.  If not, please follow the below.</p>
<p>You will use the account identifiers collected above to prepare the clean room deployment scripts.  In this Quickstart, we will use the <a href="https://snowflake-labs-sfquickstart-data-cle-dcr-setup-assistant-bkx7gg.streamlitapp.com/" target="_blank">Streamlit-based DCR Setup Assistant app</a> to automate the process.</p>
<p>First, <a href="https://snowflake-labs-sfquickstart-data-cle-dcr-setup-assistant-bkx7gg.streamlitapp.com/" target="_blank">click here</a> to open our Streamlit-based DCR Setup Assistant app.</p>
<p class="image-container"><img alt="DCR Setup Assistant Screenshot" src="img/4b0f7af906d0d0e9.png"></p>
<p>Next, place your PROVIDER_1 and CONSUMER_1 account identifiers in their respective fields. Note that you should leave the database abbreviation field blank.  Make sure to load the Media &amp; Advertising demo data, as this will be used in the examples below.</p>
<p>Now click the <strong>Run</strong> button.  You&#39;ll see a fun snowfall animation, and then a <strong>Scripts Ready for Download!</strong> message will display.  At that point you can click the <strong>Download Scripts</strong> button, which will initiate the download of a file called <code>dcr_scripts.zip</code> to your local machine.  Go ahead and unzip this file, which contains a set of SQL scripts that were custom-generated by the DCR Setup Assistant for your specific account IDs:</p>
<ul>
<li><code>1 - provider_init.sql</code></li>
<li><code>2 - provider_data.sql</code></li>
<li><code>3 - provider_templates.sql</code></li>
<li><code>4 - consumer_init.sql</code></li>
<li><code>5 - consumer_data.sql</code></li>
<li><code>6 - provider_enable_consumer.sql</code></li>
<li><code>7 - consumer_request.sql</code></li>
</ul>
<h2 is-upgraded>Generate scripts for additional provider for PROVIDER_2</h2>
<p>Next, you will use the <a href="https://snowflake-labs-sfquickstart-data-cle-dcr-setup-assistant-bkx7gg.streamlitapp.com/" target="_blank">DCR Setup Assistant app</a> again to add an additional provider to our clean room.  First, select <strong>Add Add&#39;l Provider</strong> on the left.  It will look as follows:</p>
<p class="image-container"><img alt="Add Additional Provider" src="img/cf591fb694111903.png"></p>
<p>Fill the new PROVIDER_2 identifier to the <strong>What is the Provider&#39;s account identifier?</strong> field and put the CONSUMER_1 identifier in the <strong>What is the Consumer&#39;s account identifier?</strong> field. Next, click <strong>Run</strong>.  Once the scripts are ready to download, click <strong>Download Scripts</strong> and another zip file will be downloaded.  Unzip the file, and the following scripts will be present:</p>
<ul>
<li><code>1 - provider_init.sql</code></li>
<li><code>2 - provider_data.sql</code></li>
<li><code>3 - provider_templates.sql</code></li>
<li><code>4 - consumer_init_new_provider.sql</code></li>
<li><code>5 - provider_enable_consumer.sql</code></li>
<li><code>6 - consumer_request.sql</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Run the scripts to create the clean room for first provider and consumer" duration="12">
        <p>Next we need to run the scripts generated by the Setup Assistant to create the clean room.  If you have run through the two-party DCR Quickstart, and have not cleaned up the created objects, you can skip ahead to the second provider section.</p>
<h2 is-upgraded>Run the first provider initialization script</h2>
<p>Open a new worksheet in the <strong>PROVIDER_1</strong> account and rename it to <code>provider_init.sql</code>.  Next, either import or copy/paste the contents of the <code>1 - provider_init.sql</code> script into this new worksheet. Run the entire script - the easiest way to do this is to place your cursor anywhere in the worksheet, do a &#34;Select All&#34;, and then click the blue triangle run button in the upper-right corner.  The script should run without error.  Note that it is designed to be re-runnable, so if you do encounter any issues (or if it gets &#34;stuck&#34; for any reason) you can confidently re-run the entire script as needed.  It should complete execution within 1-2 minutes.</p>
<p>Take a look at the database and schemas that were created during its execution.  You should notice that a database called <code>DCR_SAMP_PROVIDER_DB</code> has been created - this database contains all of the Provider&#39;s DCR objects.  For future reference, the <a href="https://snowflake-labs-sfquickstart-data-cle-dcr-setup-assistant-bkx7gg.streamlitapp.com/" target="_blank">DCR Setup Assistant App</a> that we used to generate these scripts will replace <code>DCR_SAMP</code> prefix here with whatever you put into the &#34;Database Abbreviation&#34; field (we simply left that field blank for the purposes of this Quickstart, however).</p>
<h2 is-upgraded>Run the provider data and templates scripts</h2>
<p>Open a new worksheet in the <strong>PROVIDER_1</strong> account and rename it to <code>provider_data.sql</code>.  Next, either import or copy/paste the contents of the <code>2 - provider_data.sql</code> script into this new worksheet, and then run it in its entirety just like you did in the prior step.  As before, this script should run without error, and can be re-run if needed.</p>
<p>Do likewise for the <code>3 - provider_templates.sql</code> script.  Note, however, that this script <em>is not</em> designed to be re-runnable, so if you do happen to encounter any issues then you&#39;ll want to completely clean out the <code>DCR_TEMPLATES</code> table before running it again by executing this command:</p>
<pre><code language="language-sql" class="language-sql">delete from dcr_samp_provider_db.templates.dcr_templates;
</code></pre>
<h2 is-upgraded>Run the consumer initialization and data scripts</h2>
<p>Open a new worksheet in the <strong>CONSUMER_1</strong> account and rename it to <code>consumer_init.sql</code>.  Either import or copy/paste the contents of the <code>4 - consumer_init.sql</code> script into this new worksheet. Go ahead and run the entire script, just like you did for the Provider account scripts.  It should run without error within 1-2 minutes, and - like its <strong>Provider Initialization Script</strong> counterpart - is designed to be re-runnable as needed.</p>
<p>Do likewise for the  <code>5 - consumer_data.sql</code> script.</p>
<p>Notice how these scripts have created <em>two</em> databases - <code>DCR_SAMP_APP</code> and <code>DCR_SAMP_CONSUMER</code> - in addition to a variety of schemas.  Again, I&#39;ll provide more details about the objects in these schemas later.</p>
<h2 is-upgraded>Run the consumer enablement script</h2>
<p>Next you will enable the newly-created Consumer.  This is done from the first provider&#39;s account, so return to the <strong>PROVIDER_1</strong> account&#39;s UI and open a new worksheet named <code>provider_enable_consumer.sql</code>.<br> Either import or copy/paste the contents of the <code>provider_enable_consumer.sql</code> script into this new worksheet and run it in its entirety.</p>
<p class="image-container"><img alt="Consumer Enablement Screenshot" src="img/c5fd006fd2a81031.png"></p>
<p>As noted in the screenshot above, the script starts a fleet of six request processing tasks separated by 8-second intervals.  Each task is scheduled to run once a minute.  If you look at the definition of each task, you&#39;ll note the inclusion of a <code>WHEN</code> clause that checks for data in a <a href="https://docs.snowflake.com/en/user-guide/streams.html" target="_blank">stream object</a> defined for the Consumer&#39;s <code>REQUESTS</code> table before running the task.  For example:</p>
<pre><code language="language-sql" class="language-sql">CREATE OR REPLACE TASK dcr_samp_provider_db.admin.process_requests_AIB26900_1
  SCHEDULE = &#39;1 minute&#39;  WAREHOUSE = &#39;app_wh&#39;
WHEN SYSTEM$STREAM_HAS_DATA(&#39;dcr_samp_provider_db.admin.request_stream_AIB26900&#39;)
AS call dcr_samp_provider_db.admin.process_requests(&#39;AIB26900&#39;);
</code></pre>
<p>We&#39;ll discuss this stream object later.  For now, just know that the <code>WHEN</code> clause in these task definitions ensures that each task only runs when there&#39;s at least one request waiting to be processed, which allows the <code>APP_WH</code> virtual warehouse to shut down when the DCR deployment isn&#39;t in use.  That&#39;s right - these tasks <em>won&#39;t</em> consume credits until a new record is added to the Consumer&#39;s <code>REQUESTS</code> table, so there&#39;s no need for concern!  But if you ever do need to shut them down then simply copy the corresponding <code>SUSPEND</code> commands to a new worksheet, uncomment, and run (I&#39;ve highlighted as &#34;Optional&#34; in the screenshot above).</p>


      </google-codelab-step>
    
      <google-codelab-step label="Run scripts for additional provider" duration="12">
        <p>Next we will run the scripts produced for adding the additional provider.</p>
<h2 is-upgraded>Run the second provider initialization and data scripts</h2>
<p>Here you will follow the same process that you followed for the first provider in the account of the second provider.  Create worksheets for <code>1 - provider_init.sql</code> and <code>2 - provider_data.sql</code> and run the entire scripts, in turn.  As noted previously, these scripts are designed to be idempotent, so they can be re-run if you run into any problems.</p>
<h2 is-upgraded>Run the second provider templates script</h2>
<p>As before with the first provider&#39;s templates script, you will run <code>3 - provider_templates.sql</code> in its entirety.  Keep in mind that as with the first provider, this script is not designed to be run multiple times.</p>
<h2 is-upgraded>Initialize the second provider with the consumer</h2>
<p>Next, we return to CONSUMER_1 to initialize the connection to the new PROVIDER_2. Open the UI for CONSUMER_1 and create a new worksheet named <code>consumer_init_new_provider.sql</code> and import or paste the code from <code>4 - consumer_init_new_provider.sql</code>. Run the code in its entirety.</p>
<h2 is-upgraded>Run the consumer enablement script from the second provider</h2>
<p>Next you will enable the consumer.  This is done from the second provider&#39;s account, so return to the <strong>PROVIDER_2</strong> account&#39;s UI and open a new worksheet named <code>provider_enable_consumer.sql</code>.<br> Either import or copy/paste the contents of the <code>provider_enable_consumer.sql</code> script into this new worksheet and run it in its entirety.  This works the same as the consumer enablement script run from the first provider.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Clean Room Objects" duration="6">
        <p>To get a detailed overview of the objects created and the architecture of the clean room, please review the details from the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#3" target="_blank">previous Quickstart</a>.  In this section, we will focus just on the flow and template for the multiparty use case.</p>
<h2 is-upgraded>Overall flow</h2>
<p>The following illustrates the overall flow we will follow for the multiparty use case.</p>
<p class="image-container"><img alt="Multiparty architecture" src="img/9d2dd12aaa0e83a6.png"></p>
<p>Note that the providers must share a template. The flow is then as follows:</p>
<ol type="1">
<li>The consumer makes a call to the first provider and gets the request ID.</li>
<li>The consumer calls the second provider, and provides the request ID from the first provider.</li>
<li>The consumer executes the combined query.</li>
</ol>
<h2 is-upgraded>Multiparty template</h2>
<p>In order for this multiparty scenario to work, the providers must use the same template. You can see the template by running the following in one of the provider accounts.</p>
<pre><code language="language-sql" class="language-sql">select * from dcr_samp_provider_db.templates.dcr_templates;
</code></pre>
<p>You will see one row with the template name <strong>customer_overlap_multiparty</strong> with the template as follows:</p>
<pre><code language="language-sql" class="language-sql">select
    identifier(&#123;&#123; dimensions[0] }})
    {% for dim in dimensions[1:] %}
    , identifier(&#123;&#123; dim  }})
    {% endfor %}
    , count(distinct p.email) as overlap
from
    &#123;&#123; app_data | sqlsafe }}.cleanroom.provider_customers_vw p,
    &#123;&#123; app_two_data | sqlsafe }}.cleanroom.provider_customers_vw p2,
    &#123;&#123; consumer_db | sqlsafe }}.&#123;&#123; consumer_schema | sqlsafe }}.&#123;&#123; consumer_table | sqlsafe }} at(timestamp =&gt; &#39;&#123;&#123; at_timestamp | sqlsafe }}&#39;::timestamp_ntz) c
where
    c.&#123;&#123; consumer_join_field | sqlsafe }} = p.email
    and c.&#123;&#123; consumer_join_field | sqlsafe }} = p2.email
    and exists (select table_name from &#123;&#123; consumer_db | sqlsafe }}.information_schema.tables where table_schema = upper(&#39;&#123;&#123; consumer_schema | sqlsafe }}&#39;) and table_name = upper(&#39;&#123;&#123; consumer_table| sqlsafe }}&#39;) and table_type = &#39;BASE TABLE&#39;)
    {% if  where_clause  %}
    and ( &#123;&#123; where_clause | sqlsafe }} )
    {% endif %}
group by
    identifier(&#123;&#123; dimensions[0]  }})
    {% for dim in dimensions[1:] %}
    , identifier(&#123;&#123; dim }})
    {% endfor %}
having count(distinct p.email)  &gt; 25
order by count(distinct p.email) desc;
</code></pre>
<p>As you can see, this template joins the email in the consumer&#39;s table to the email in both provider&#39;s tables.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Three-Party Data Clean Room Demo" duration="12">
        <p>Now that the clean room is set up, we can show how it can be used to answer reach-type questions for an advertiser.  Open a new worksheet in the <strong>CONSUMER_1</strong> account&#39;s UI and rename it to <code>consumer_request.sql</code>.  Either import or copy/paste the contents of the <code>consumer_request.sql</code> script into this new worksheet. Go ahead and run the first couple of commands to set the current role and virtual warehouse context.  You&#39;re welcome to run the queries that appear directly below those commands if you&#39;d like - these give you a chance to familiarize yourself with the current state of the Consumer before getting underway.</p>
<p>Our goal will be to understand the overlap of CONSUMER_1 with each of PROVIDER_1 and PROVIDER_2 individually, as well as to understand the overlap of all three parties.</p>
<h2 is-upgraded>Demo 1: Customer Overlap on EMAIL with PROVIDER_1</h2>
<p>It&#39;s time now to run a <code>call</code> command like the one in the first demo section that executes the <code>REQUEST</code> stored procedure for the <code>customer_overlap</code> template.  You should see a <em>Request Sent</em> acknowledgment returned after a moment or two.  For the example, I use the <code>age_band</code> dimension, but you should feel free to experiement with other options like <code>pets</code>, <code>zip</code>, and/or <code>status</code>. The call should look like the following:</p>
<pre><code language="language-sql" class="language-sql">call dcr_samp_consumer.&lt;PROVIDER_1_ACCOUNT&gt;_schema.request(&#39;customer_overlap&#39;,
        object_construct(
            &#39;dimensions&#39;,array_construct(&#39;p.age_band&#39;)
            )::varchar, NULL, NULL);
</code></pre>
<p>Wait at least 5-10 seconds so that one of the fleet of tasks in the Provider&#39;s account which monitor the stream on the <code>REQUESTS</code> table will have recognized that a new request has been inserted.  That task will have thus called the <code>PROCESS_REQUESTS</code> stored procedure, which then evaluates the request and writes its decision back to the <code>REQUEST_LOG</code> table.</p>
<p>You can now go ahead and run the next query, which selects from the <code>DCR_SAMP_APP.CLEANROOM.PROVIDER_LOG</code> table.</p>
<pre><code language="language-sql" class="language-sql">select REQUEST_ID, APPROVED, request:PROPOSED_QUERY::varchar from dcr_samp_app.cleanroom.provider_log;
</code></pre>
<p>Take a look at the record that gets returned.  You should see your request&#39;s unique ID in the first column, an <code>APPROVED</code> column which shows Boolean <code>TRUE</code>, and finally a third column which contains the proposed query that was assembled for you by the <code>GET_SQL_JINJA</code> UDF.  Assuming all of this this is as I&#39;ve just described, you&#39;re now approved to proceed with your query!  Here&#39;s how to do that:</p>
<ol type="1">
<li>Click on the query text cell in the third column.</li>
<li>Click on the &#34;Copy&#34; icon in the text focus box on the lower right (see my screenshot below).</li>
<li>Paste the query text into the worksheet beneath the <code>\\ run query</code> comment line which appears directly below the <code>PROVIDER_LOG</code> query that you just ran.</li>
<li>And, finally, run the query that you just pasted into the worksheet.</li>
</ol>
<p>The query should look like the following:</p>
<pre><code language="language-sql" class="language-sql">select
    identifier(&#39;p.age_band&#39;)
    , 
    count(distinct p.email) as overlap
from
    dcr_samp_app.cleanroom.provider_customers_vw p,
    dcr_samp_consumer.mydata.customers at(timestamp =&gt; &#39;2023-02-10 19:15:09.697&#39;::timestamp_ntz) c
where
    c.email = p.email
    and exists (select table_name from dcr_samp_consumer.information_schema.tables where table_schema = upper(&#39;mydata&#39;) and table_name = upper(&#39;customers&#39;) and table_type = &#39;BASE TABLE&#39;)
    group by identifier(&#39;p.age_band&#39;)
having count(distinct p.email)  &gt; 25
order by count(distinct p.email) desc;
</code></pre>
<p>You should get a result set back which provides overlapping customer counts (called <code>OVERLAP</code> in the result set) grouped by column <code>AGE_BAND</code>.</p>
<h2 is-upgraded>Demo 2: Customer Overlap on EMAIL with PROVIDER_2</h2>
<p>Now we will repeat the above process, except we will change the request to the PROVIDER_2 account schema.  Then again select the query from the <code>PROVIDER_LOG</code>, this time using <code>DCR_SAMP_APP_TWO</code> as follows:</p>
<pre><code language="language-sql" class="language-sql">select REQUEST_ID, APPROVED, request:PROPOSED_QUERY::varchar from dcr_samp_app_two.cleanroom.provider_log;
</code></pre>
<p>Again, select the query and run it as before.</p>
<h2 is-upgraded>Demo 3: Customer overlap on EMAIL with BOTH PROVIDER_1 and PROVIDER_2</h2>
<p>Next, we want to understand the overlap of all three parties. For the queries to use, you can scroll down to the <strong>REQUEST 4</strong> section of the <code>consumer_request.sql</code> notebook the CONSUMER_1 account.  Here we will edit the query to use only the <code>p.age_band</code> dimension.</p>
<p>First, we run the following to set the <code>ts</code> variable to be used later.</p>
<pre><code language="language-sql" class="language-sql">set ts = SYSDATE();
</code></pre>
<p>Next, we fire a request to the first provider as follows:</p>
<pre><code language="language-sql" class="language-sql">// clean room app creates and signs the request
call dcr_samp_consumer.&lt;PROVIDER_1_ACCOUNT&gt;_schema.request(&#39;customer_overlap_multiparty&#39;,
        object_construct(
            &#39;dimensions&#39;,array_construct(&#39;p.age_band&#39;)
            )::varchar, NULL, $ts);
</code></pre>
<p>Next, you need to get the request ID to pass to the second provider.</p>
<pre><code language="language-sql" class="language-sql">// if multi-party, get request ID for use in second provider request
set request_id1 = (select request_id from dcr_samp_consumer.&lt;PROVIDER_1_ACCOUNT&gt;_schema.requests where request:REQUEST_PARAMS.at_timestamp::varchar=$ts);
</code></pre>
<p>Next, wait for the query to be approved by PROVIDER_1.  You can verify wih the following query:</p>
<pre><code language="language-sql" class="language-sql">// wait 5-10 seconds for this query to show the request as approved
select REQUEST_ID, APPROVED, request:PROPOSED_QUERY::varchar, * from dcr_samp_app.cleanroom.provider_log order by request_ts desc;
</code></pre>
<p>Now the consumer needs to pass the request ID set above in the call to the PROVIDER_2 clean room.</p>
<pre><code language="language-sql" class="language-sql">// clean room app creates and signs the request
call dcr_samp_consumer.&lt;PROVIDER_2_ACCOUNT&gt;_schema.request(&#39;customer_overlap_multiparty&#39;,
        object_construct(
            &#39;dimensions&#39;,array_construct(&#39;p.age_band&#39;)
            )::varchar, $request_id1, $ts);
</code></pre>
<p>Once again, we wait for the query to be approved by PROVIDER_2.</p>
<pre><code language="language-sql" class="language-sql">// wait 5-10 seconds for this query to show the request as approved
select REQUEST_ID, APPROVED, request:PROPOSED_QUERY::varchar, * from dcr_samp_app_two.cleanroom.provider_log order by request_ts desc;
</code></pre>
<p>Now copy the SQL from result like the following.</p>
<p class="image-container"><img alt="Copy SQL query" src="img/e4a4c5abcf315924.png"></p>
<p>The query will look like the following:</p>
<pre><code language="language-sql" class="language-sql">select
    identifier(&#39;p.age_band&#39;)
    , count(distinct p.email) as overlap
from
    dcr_samp_app.cleanroom.provider_customers_vw p,
    dcr_samp_app_two.cleanroom.provider_customers_vw p2,
    dcr_samp_consumer.mydata.customers at(timestamp =&gt; &#39;2023-02-10 22:10:00.513&#39;::timestamp_ntz) c
where
    c.email = p.email
    and c.email = p2.email
    and exists (select table_name from dcr_samp_consumer.information_schema.tables where table_schema = upper(&#39;mydata&#39;) and table_name = upper(&#39;customers&#39;) and table_type = &#39;BASE TABLE&#39;)
group by
    identifier(&#39;p.age_band&#39;)
having count(distinct p.email)  &gt; 25
order by count(distinct p.email) desc;
</code></pre>
<p>Running this query gives you the result with all three overlapped.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Reset / Drop" duration="2">
        <h2 is-upgraded>Quick Reset</h2>
<p>This simply restores the DCR deployment to its original state (no query requests or approved queries):</p>
<ul>
<li>Consumer account - Delete the contents of the <code>REQUESTS</code> table in the Provider-specific schema of the <code>DCR_SAMP_CONSUMER</code> database.</li>
<li>Provider accounts - Delete the contents of the <code>DCR_SAMP_PROVIDER_DB.ADMIN.REQUEST_LOG</code> table.</li>
</ul>
<h2 is-upgraded>Drop All Quickstart Objects</h2>
<p>Our <a href="https://snowflake-labs-sfquickstart-data-cle-dcr-setup-assistant-bkx7gg.streamlitapp.com/" target="_blank">Streamlit-based DCR Setup Assistant app</a> generates custom scripts to automate the process of dropping all objects associated with the DCR deployment from Consumer and/or Provider accounts.</p>
<p class="image-container"><img alt="Uninstall scripts download" src="img/4796c574d5ed49b7.png"></p>
<p>You will download three scripts, one for the consumer, and one for each provider.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion" duration="1">
        <p>This Quickstart has extended on the <a href="https://quickstarts.snowflake.com/guide/build_a_data_clean_room_in_snowflake_advanced/index.html?index=..%2F..index#0" target="_blank">two-party Data Clean Room Quickstart</a>, showing how a consumer can query for overlap between two providers. This is a common use case for advertisers who work with multiple publishers, and want to understand how the audiences overlap, often for calculating <a href="https://quickstarts.snowflake.com/guide/reach_and_frequency_queries/index.html#0" target="_blank">Reach and Frequency</a>.</p>
<h2 is-upgraded>What You&#39;ve Learned</h2>
<ul>
<li>How to create and deploy a DCR environment between three Snowflake accounts</li>
<li>How DCR query requests are initiated from one Snowflake account to another</li>
<li>How DCR query requests are reviewed and approved (or declined)</li>
<li>How approved DCR query requests are executed</li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/native-shim.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/custom-elements.min.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/prettify.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("2025084205");
  </script>
</body>
</html>
